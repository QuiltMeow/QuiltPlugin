package ew.quilt.patch;

import com.bekvon.bukkit.residence.Residence;
import com.bekvon.bukkit.residence.protection.ClaimedResidence;
import ew.quilt.Config.ConfigManager;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerCommandPreprocessEvent;
import org.bukkit.event.player.PlayerTeleportEvent;

public class ResidenceTPExploit implements Listener {

    @EventHandler(priority = EventPriority.HIGHEST)
    public void onPlayerTeleport(PlayerTeleportEvent event) {
        Location to = event.getTo();
        if (event.getFrom().getWorld() == to.getWorld()) {
            return;
        }

        Player player = event.getPlayer();
        ClaimedResidence res = Residence.getInstance().getResidenceManager().getByLoc(to);
        if (res != null && !res.getPermissions().playerHas(player, "tp", false) && !Residence.getInstance().isResAdminOn(player) && !ConfigManager.isAuthorSender(player)) {
            player.sendMessage(ChatColor.RED + "很抱歉 您沒有該領地傳送權限 無法進行移動 ...");
            event.setCancelled(true);
        }
    }

    @EventHandler(priority = EventPriority.HIGHEST)
    public void onPlayerTPUnstuck(PlayerCommandPreprocessEvent event) {
        Player player = event.getPlayer();
        if (player.hasPermission("quilt.residence.use.tp.unstuck")) {
            return;
        }
        String[] args = event.getMessage().split(" ");
        if (args.length >= 2) {
            if (args[0].equalsIgnoreCase("/res") || args[0].equalsIgnoreCase("/residence")) {
                if (args[1].equalsIgnoreCase("unstuck")) {
                    player.sendMessage(ChatColor.RED + "很抱歉 該指令無法使用 ...");
                    event.setCancelled(true);
                }
            }
        }
    }
}
